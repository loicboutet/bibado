<% content_for :title do %>Meal Plan - Bibado<% end %>

<div data-controller="meal-calendar" class="min-h-screen bg-gray-50">
  <!-- Week/Day/Month Navigation -->
  <div class="bg-white border-b border-gray-200 px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <%= link_to mockups_meal_plan_path(week: (@current_week || 2) - 1), class: "p-2 hover:bg-gray-100 rounded-full" do %>
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        <% end %>
        <h1 class="font-semibold text-[#2C3E50]">Week <%= @current_week || 2 %> - December</h1>
        <%= link_to mockups_meal_plan_path(week: (@current_week || 2) + 1), class: "p-2 hover:bg-gray-100 rounded-full" do %>
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        <% end %>
      </div>
      <div class="flex bg-gray-100 rounded-lg p-1">
        <%= link_to day_mockups_meal_plan_path, class: "px-3 py-1 text-sm rounded #{'bg-white shadow' if params[:view] == 'day'}" do %>D<% end %>
        <%= link_to mockups_meal_plan_path, class: "px-3 py-1 text-sm rounded bg-white shadow font-medium" do %>W<% end %>
        <%= link_to month_mockups_meal_plan_path, class: "px-3 py-1 text-sm rounded #{'bg-white shadow' if params[:view] == 'month'}" do %>M<% end %>
      </div>
    </div>
  </div>

  <!-- Interactive Tip -->
  <div class="bg-[#4ECDC4]/10 px-4 py-2 border-b border-[#4ECDC4]/20">
    <p class="text-xs text-[#2C3E50] text-center">
      ðŸ’¡ <strong>Tip:</strong> Drag and drop meals to swap them, or tap a meal to see options
    </p>
  </div>

  <!-- Week Grid -->
  <div class="px-2 py-3">
    <div class="grid grid-cols-7 gap-1 mb-2">
      <% days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %>
      <% dates = [15, 16, 17, 18, 19, 20, 21] %>
      <% days.each_with_index do |day, idx| %>
        <%= link_to day_mockups_meal_plan_path(day: dates[idx]), class: "text-center py-2 rounded-lg hover:bg-gray-100 transition-colors #{dates[idx] == 17 ? 'bg-[#FF6B6B] text-white' : ''}" do %>
          <div class="text-xs font-medium <%= dates[idx] == 17 ? 'text-white' : 'text-gray-500' %>"><%= day %></div>
          <div class="text-sm font-bold <%= dates[idx] == 17 ? 'text-white' : 'text-[#2C3E50]' %>"><%= dates[idx] %></div>
        <% end %>
      <% end %>
    </div>

    <!-- Meal Slots Grid -->
    <div class="space-y-2">
      <% meal_types = ['Breakfast', 'Lunch', 'Dinner'] %>
      <% 
        # Sample meal data with emojis and metadata
        week_meals = {
          'Breakfast' => [
            { id: 1, name: 'Banana Porridge', emoji: 'ðŸŒ', iron: false, allergen: false },
            { id: 2, name: 'Avocado Toast', emoji: 'ðŸ¥‘', iron: false, allergen: true },
            { id: 3, name: 'Apple Oats', emoji: 'ðŸŽ', iron: true, allergen: false },
            { id: 4, name: 'Egg Scramble', emoji: 'ðŸ¥š', iron: true, allergen: true },
            { id: 5, name: 'Yogurt Bowl', emoji: 'ðŸ¥£', iron: false, allergen: true },
            { id: 6, name: 'Sweet Potato', emoji: 'ðŸ ', iron: false, allergen: false },
            { id: 7, name: 'Oat Pancakes', emoji: 'ðŸ¥ž', iron: false, allergen: true }
          ],
          'Lunch' => [
            { id: 8, name: 'Chicken Puree', emoji: 'ðŸ—', iron: true, allergen: false },
            { id: 9, name: 'Veggie Mash', emoji: 'ðŸ¥¦', iron: true, allergen: false },
            { id: 10, name: 'Fish Fingers', emoji: 'ðŸŸ', iron: false, allergen: true },
            { id: 11, name: 'Lentil Soup', emoji: 'ðŸ¥£', iron: true, allergen: false },
            { id: 12, name: 'Pasta Stars', emoji: 'â­', iron: false, allergen: true },
            { id: 13, name: 'Bean Mash', emoji: 'ðŸ«˜', iron: true, allergen: false },
            { id: 14, name: 'Rice Bowl', emoji: 'ðŸš', iron: false, allergen: false }
          ],
          'Dinner' => [
            { id: 15, name: 'Beef Stew', emoji: 'ðŸ¥©', iron: true, allergen: false },
            { id: 16, name: 'Salmon Bites', emoji: 'ðŸ£', iron: false, allergen: true },
            { id: 17, name: 'Chicken Rice', emoji: 'ðŸ—', iron: true, allergen: false },
            { id: 18, name: 'Veggie Curry', emoji: 'ðŸ›', iron: true, allergen: false },
            { id: 19, name: 'Pasta Bolognese', emoji: 'ðŸ', iron: true, allergen: true },
            { id: 20, name: 'Tofu Stir-fry', emoji: 'ðŸ¥¡', iron: true, allergen: true },
            { id: 21, name: 'Fish Pie', emoji: 'ðŸŸ', iron: false, allergen: true }
          ]
        }
      %>

      <% meal_types.each do |meal_type| %>
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="px-3 py-2 bg-gray-50 border-b border-gray-100">
            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide"><%= meal_type %></span>
          </div>
          <div class="grid grid-cols-7 gap-px bg-gray-100 p-px">
            <% week_meals[meal_type].each_with_index do |meal, day_idx| %>
              <div 
                class="bg-white p-1 min-h-[70px] flex flex-col items-center justify-center cursor-grab active:cursor-grabbing transition-all duration-200 hover:bg-gray-50 relative"
                data-meal-calendar-target="mealSlot"
                data-meal-id="<%= meal[:id] %>"
                data-meal-name="<%= meal[:name] %>"
                data-meal-emoji="<%= meal[:emoji] %>"
                data-has-meal="true"
                data-iron-rich="<%= meal[:iron] %>"
                data-allergen="<%= meal[:allergen] %>"
                data-action="click->meal-calendar#showPreview"
              >
                <!-- Iron/Allergen indicators -->
                <div class="absolute top-0.5 right-0.5 flex gap-0.5">
                  <% if meal[:iron] %>
                    <span class="w-2 h-2 rounded-full bg-red-500" title="Iron Rich"></span>
                  <% end %>
                  <% if meal[:allergen] %>
                    <span class="w-2 h-2 rounded-full bg-amber-400" title="Allergen"></span>
                  <% end %>
                </div>
                
                <span class="meal-emoji text-xl mb-0.5"><%= meal[:emoji] %></span>
                <span class="meal-name text-[10px] text-gray-600 text-center leading-tight line-clamp-2"><%= meal[:name].split(' ').first %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Legend -->
  <div class="px-4 py-3">
    <div class="flex items-center justify-center gap-4 text-xs">
      <div class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full bg-red-500"></span>
        <span class="text-gray-600">Iron Rich</span>
      </div>
      <div class="flex items-center gap-1">
        <span class="w-3 h-3 rounded-full bg-amber-400"></span>
        <span class="text-gray-600">Allergen</span>
      </div>
    </div>
  </div>

  <!-- Weekly Summary -->
  <div class="px-4 pb-4">
    <div class="bg-white rounded-xl shadow-sm p-4">
      <h3 class="font-semibold text-[#2C3E50] mb-3">This Week's Progress</h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="text-center p-3 bg-red-50 rounded-lg">
          <div class="text-2xl font-bold text-red-600">12</div>
          <div class="text-xs text-gray-600">Iron-rich meals</div>
        </div>
        <div class="text-center p-3 bg-amber-50 rounded-lg">
          <div class="text-2xl font-bold text-amber-600">8</div>
          <div class="text-xs text-gray-600">New allergens</div>
        </div>
        <div class="text-center p-3 bg-green-50 rounded-lg">
          <div class="text-2xl font-bold text-green-600">15</div>
          <div class="text-xs text-gray-600">New foods</div>
        </div>
        <div class="text-center p-3 bg-purple-50 rounded-lg">
          <div class="text-2xl font-bold text-purple-600">21</div>
          <div class="text-xs text-gray-600">Total meals</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Log Meal Button -->
  <div class="fixed bottom-24 right-4 z-30 sm:right-auto sm:left-1/2 sm:translate-x-[140px]">
    <%= link_to feedback_mockups_meal_plan_path, class: "flex items-center gap-2 bg-[#FF6B6B] text-white px-4 py-3 rounded-full shadow-lg hover:bg-[#E85555] transition-colors" do %>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      <span class="font-medium">Log Meal</span>
    <% end %>
  </div>

  <!-- Preview Modal -->
  <div data-meal-calendar-target="previewModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4" data-action="click->meal-calendar#hidePreview">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-5 transform transition-all" data-action="click->meal-calendar#stopPropagation">
      <div data-meal-calendar-target="previewContent">
        <!-- Content populated by JS -->
      </div>
    </div>
  </div>

  <!-- Swap Modal -->
  <div data-meal-calendar-target="swapModal" class="fixed inset-0 z-50 hidden items-end justify-center bg-black/50" data-action="click->meal-calendar#closeSwapModal">
    <div class="bg-white rounded-t-3xl shadow-xl w-full max-w-md p-5 pb-8 animate-slide-up" onclick="event.stopPropagation()">
      <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
      <h3 class="font-bold text-lg text-[#2C3E50] mb-4">Swap for alternative</h3>
      
      <div class="space-y-2 max-h-60 overflow-y-auto">
        <% [
          { id: 100, name: 'Vegetarian Option', emoji: 'ðŸ¥—', desc: 'Plant-based alternative' },
          { id: 101, name: 'Dairy-Free Option', emoji: 'ðŸŒ±', desc: 'No dairy ingredients' },
          { id: 102, name: 'Quick & Easy', emoji: 'âš¡', desc: '5-minute prep time' },
          { id: 103, name: 'Similar Nutrition', emoji: 'ðŸ’ª', desc: 'Same iron content' }
        ].each do |option| %>
          <button 
            class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors text-left border border-gray-200"
            data-action="click->meal-calendar#selectSwapOption"
            data-meal-id="<%= option[:id] %>"
            data-meal-name="<%= option[:name] %>"
            data-meal-emoji="<%= option[:emoji] %>"
          >
            <span class="text-2xl"><%= option[:emoji] %></span>
            <div>
              <div class="font-medium text-[#2C3E50]"><%= option[:name] %></div>
              <div class="text-xs text-gray-500"><%= option[:desc] %></div>
            </div>
          </button>
        <% end %>
      </div>
      
      <button 
        class="w-full mt-4 py-3 text-gray-500 font-medium"
        data-action="click->meal-calendar#closeSwapModal"
      >
        Cancel
      </button>
    </div>
  </div>
</div>

<style>
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  .animate-slide-up {
    animation: slideUp 0.3s ease-out;
  }
  
  @keyframes bounceIn {
    0% { transform: translate(-50%, 20px); opacity: 0; }
    50% { transform: translate(-50%, -5px); }
    100% { transform: translate(-50%, 0); opacity: 1; }
  }
  .animate-bounce-in {
    animation: bounceIn 0.4s ease-out;
  }
  
  .touch-dragging {
    transition: none !important;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
